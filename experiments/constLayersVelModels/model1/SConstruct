#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# SConstruct  (Madagascar Script)
#
# Purpose: Common Reflection Element (CRE) stack applied to a seismic data cube
# from Kirchhoff Newton modeling of a multi layer velocity model.
#
# IMPORTANT: This experiment uses the new version of creGatherStack programs
# adapted to the new version of the VFSA package (2.0).
#
# Site: https://dirack.github.io
# 
# Version 2.0
#
# Programer: Rodolfo A. C. Neves (Dirack) 04/08/2021
#
# Email: rodolfo_profissional@hotmail.com
#
# License: GPL-3.0 <https://www.gnu.org/licenses/gpl-3.0.txt>.

# Madagascar package
from rsf.proj import *

# CRE Gather Stack Recipe
#from creGatherStack import creGatherStack

# It uses Very Fast Simulated Aneeling and non hyperbolic CRS
# to get zero offset CRS parameters (RN, RNIP and BETA) from data cube
stackedSection='stackedSection'
parametersCube='parametersCube'
dataCube='multiLayerDataCube.rsf'
interpolatedDataCube='interpolatedDataCube2.rsf'

# Parameters
v0 = float(ARGUMENTS.get('v0',1.5))
ot0 = float(ARGUMENTS.get('ot0',0.3))
dt0 = float(ARGUMENTS.get('dt0',0.008))
nt0 = int(ARGUMENTS.get('nt0',331))
om0 = float(ARGUMENTS.get('om0',2))
dm0 = float(ARGUMENTS.get('dm0',0.25))
nm0 = int(ARGUMENTS.get('nm0',8))
aperture = int(ARGUMENTS.get('aperture',1))
cds = bool(ARGUMENTS.get('cds',False))

Flow(parametersCube,dataCube,
	'''
	vfsacrsnh nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g v0=%g repeat=2 
	'''%(nm0,om0,dm0,nt0,ot0,dt0,v0))

Flow('creTrajectories',[dataCube,parametersCube],
	'''
	cretrajec param=${SOURCES[1]} nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g verb=y 
	'''%(nm0,om0,dm0,nt0,ot0,dt0))

Flow(['cregathers','mhCoordinates'],[dataCube,'creTrajectories'],
	'''
	getcregather cremh=${SOURCES[1]} m=${TARGETS[1]} nm0=%g nt0=%g aperture=10 |
	put label1=Time unit1=s label2=Offset unit2=Km label3=t0 unit3=s
	label4=m0 unit4=Km n3=%d d3=%g o3=%g n4=%d d4=%g o4=%g
	''' % (nm0,nt0,nt0,dt0,ot0,nm0,dm0,om0))

Flow('cretimecurves',['mhCoordinates',parametersCube],
	'''
	getcretimecurve param=${SOURCES[1]} nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g verb=y v0=%g |
	put label1=Offset unit1=Km label2=t0 unit2=s label3=m0 unit3=Km
	n2=%d d2=%g o2=%g n3=%d d3=%g o3=%g
	'''%(nm0,om0,dm0,nt0,ot0,dt0,v0,nt0,dt0,ot0,nm0,dm0,om0))

Flow(stackedSection,['cregathers','cretimecurves'],
	'''
	crestack aperture=2 verb=y timeCurves=${SOURCES[1]} |
	put label1=t0 unit1=s label2=m0 unit2=Km
	''')

End()
