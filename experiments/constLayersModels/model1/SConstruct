#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# SConstruct (Python3)
# 
# Purpose: CRE stacking for a constant velocity layers model.
# 
# Site: https://www.geofisicando.com
# 
# Version 1.0
# 
# Programmer: Rodolfo A C Neves (Dirack) 31/01/2022
# 
# Email: rodolfo_profissional@hotmail.com
# 
# License: GPL-3.0 <https://www.gnu.org/licenses/gpl-3.0.txt>.

__author__="Rodolfo Dirack <rodolfo_profissional@hotmail.com>"
__version__="1.0"
__site__="https://www.geofisicando.com"

Help('''
    CRE stacking for a constant velocity layers model
    =================================================

    Author: %s
    Version: %s
    Site: %s
    ''' % (__author__,__version__,__site__))

# Madagascar Package
from rsf.proj import *

# Madagascar Recipes
from rsf.recipes.pefInterpolation2 import pefInterpolation as pef
from rsf.recipes.kimodel import multiLayerModelBuild
from rsf.recipes.kimodel import kirchhoffNewtonModeling
from rsf.recipes.utils import arr2str
from rsf.recipes.utils import velplot
from rsf.recipes.utils import plotStackedSection

# Main Files
trueModel='trueModel'
stackedSection='stackedSection'
parametersCube='parametersCube'
dataCube='multiLayerDataCube'
interpolatedDataCube='interpolatedDataCube2'

# Establish building dependencies
Depends('interpolatedDataCube.rsf','multiLayerDataCube.rsf')
Depends('interpolatedDataCube2.rsf','interpolatedDataCube.rsf')
Depends('crsParameters-m0-0-t0-0.rsf','interpolatedDataCube2.rsf')

Help('''
### Kirchhoff Modeling ###

Generate the multi layers velocity model and plot
Use Kirchhoff modeling to build seismic data from this model
''')

# Velocity model parameters
xmax = 6.0
zmax = 4.0

layers = ((1.00,1.20,0.90,1.00),
          (1.85,1.85,1.85,1.85))

velocities = (1.508,
              1.690,
              2.0)

multiLayerModelBuild(
        interfaces='interfaces',
        dipsfile='interfacesDip',
        modelfile=trueModel,
        xmax=xmax,
        zmax=zmax,
        layers=layers,
        velocities=velocities)

Result(trueModel,velplot("Model 1"))

# Generate seismic data cube
nt=1001
dt=0.004
nm=241
dm=0.025
nh=161
dh=0.025

kirchhoffNewtonModeling(
        reflectors='interfaces',
        reflectorsDip='interfacesDip',
        filename=dataCube,
        velocities=velocities,
        nt=nt,
        dt=dt,
        ns=nm,
        ds=dm,
        nh=nh,
        dh=dh)

Help('''
### PEF interpolation ###

PEF interpolation to increase CMP sampling for CRE stacking
You can use default values for PEF coefficients and PEF Smooth radius
or pass it through command line

PEF interpolation is done twice
''')

# PEF interpolation coefficients and smooth radius
a1=int(ARGUMENTS.get('a1',10))
a2=int(ARGUMENTS.get('a2',2))
rect1=int(ARGUMENTS.get('rect1',50))
rect2=int(ARGUMENTS.get('rect2',2))

# Number of offsets to interpolate
nhi=int(ARGUMENTS.get('nhi',nh))

pef(dataCube=dataCube,
    interpolated='interpolatedDataCube',
    nm=nm,
    dm=dm,
    nt=nt,
    dt=dt,
    nhi=nhi,
    a1=a1,
    a2=a2,
    rect1=rect1,
    rect2=rect2)

pef('interpolatedDataCube',
    interpolatedDataCube,
    nm=2*nm,
    dm=dm/2.0,
    nt=nt,
    dt=dt,
    nhi=nhi,
    a1=a1,
    a2=a2,
    rect1=rect1,
    rect2=rect2)

Help('''
### Very Fast Simulated Annealing (VFSA) ####

Use Very Fast Simulated Annealing global optimization to get zero offset CRS parameters
(RN, RNIP and BETA) from interpolated data cube. These parameters are used to obtain CRE
gathers and CRE traveltime curves to CRE stacking
''')


# VFSA Parameters
v0 = float(ARGUMENTS.get('v0',1.5))
ot0 = float(ARGUMENTS.get('ot0',1.0))
dt0 = float(ARGUMENTS.get('dt0',0.008))
nt0 = int(ARGUMENTS.get('nt0',251))
om0 = float(ARGUMENTS.get('om0',1.5))
dm0 = float(ARGUMENTS.get('dm0',0.025))
nm0 = int(ARGUMENTS.get('nm0',121))
aperture = int(ARGUMENTS.get('aperture',25))
repeat = int(ARGUMENTS.get('repeat',4))
itmax = int(ARGUMENTS.get('itmax',500))
cds = bool(ARGUMENTS.get('cds',False))

# VFSA global optimization
Flow(parametersCube,interpolatedDataCube,
        '''
        vfsacrsnh nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g v0=%g repeat=%d itmax=%d verb=y rnmin=2 rnmax=10 rnipmin=0.3 rnipmax=3 half=y
        '''%(nm0,om0,dm0,nt0,ot0,dt0,v0,repeat,itmax))

# CRS parameters smoothing
Flow('parametersCube2',parametersCube,
	'''
	parsmoother rect1=5 rect2=5 smin=0. f=1. dbeta=0.5
	''')

Help('''
### CRE Stacking ###

Generate CRE trajectories, traveltime curves and stack
''')

# Use smoothed parameters
parametersCube='parametersCube2'

Flow('creTrajectories',[interpolatedDataCube,parametersCube],
        '''
        cretrajec param=${SOURCES[1]} nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g verb=y 
        '''%(nm0,om0,dm0,nt0,ot0,dt0))

Flow(['cregathers','mhCoordinates'],[interpolatedDataCube,'creTrajectories'],
        '''
        getcregather cremh=${SOURCES[1]} m=${TARGETS[1]} aperture=%d nm0=%g nt0=%g |
        put label1=Time unit1=s label2=Offset unit2=Km label3=t0 unit3=s
        label4=m0 unit4=Km n3=%d d3=%g o3=%g n4=%d d4=%g o4=%g
        ''' % (aperture,nm0,nt0,nt0,dt0,ot0,nm0,dm0,om0))

Flow('cretimecurves',['mhCoordinates',parametersCube],
        '''
        getcretimecurve param=${SOURCES[1]} nm0=%d om0=%g dm0=%g nt0=%d ot0=%g dt0=%g verb=y v0=%g |
        put label1=Offset unit1=Km label2=t0 unit2=s label3=m0 unit3=Km
        n2=%d d2=%g o2=%g n3=%d d3=%g o3=%g
        '''%(nm0,om0,dm0,nt0,ot0,dt0,v0,nt0,dt0,ot0,nm0,dm0,om0))

Flow(stackedSection,['cregathers','cretimecurves'],
        '''
        crestack aperture=%d verb=y timeCurves=${SOURCES[1]} |
        put label1=t0 unit1=s label2=m0 unit2=Km
        ''' %(aperture))

Result(stackedSection,plotStackedSection("Stacked Section"))

End()
